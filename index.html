<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<title>Live Score</title>
<style>
  * {
    margin: 0; padding: 0; box-sizing: border-box;
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    user-select: none;
  }
  html, body {
    width: 100%; height: 100%;
    overflow: hidden;
    background: #000;
  }
  canvas#main {
    display: block;
    width: 100%; height: 100%;
    touch-action: none;
  }

  /* Settings toggle */
  #toggle-btn {
    position: fixed;
    top: max(10px, env(safe-area-inset-top));
    right: 10px;
    width: 40px; height: 40px;
    border-radius: 50%;
    background: rgba(40,40,40,0.4);
    border: 1px solid rgba(255,255,255,0.08);
    color: rgba(255,255,255,0.25);
    font-size: 18px;
    cursor: pointer;
    z-index: 20;
    display: flex; align-items: center; justify-content: center;
    transition: opacity 0.3s;
  }
  #toggle-btn:active { background: rgba(80,80,80,0.6); }

  /* Controls panel */
  #controls {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    background: rgba(15,15,15,0.95);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    padding: 14px 20px;
    padding-bottom: max(14px, env(safe-area-inset-bottom));
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 18px;
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    font-size: 13px;
    color: #777;
    transform: translateY(100%);
    transition: transform 0.3s ease;
    z-index: 10;
  }
  #controls.visible { transform: translateY(0); }

  .cg {
    display: flex; align-items: center; gap: 8px;
  }
  .cg label {
    white-space: nowrap;
    min-width: 36px;
  }
  .cg input[type="range"] {
    width: 80px;
    accent-color: #555;
  }
  .cg .v {
    min-width: 24px;
    text-align: right;
    font-variant-numeric: tabular-nums;
    color: #999;
  }
  #controls button {
    background: #222;
    border: 1px solid #333;
    color: #aaa;
    padding: 7px 16px;
    border-radius: 6px;
    font-size: 13px;
    font-family: inherit;
    cursor: pointer;
    white-space: nowrap;
  }
  #controls button:active { background: #444; }

  /* Stylus debug HUD */
  #stylus-hud {
    position: fixed;
    top: max(10px, env(safe-area-inset-top));
    left: 10px;
    background: rgba(15,15,15,0.85);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 10px;
    padding: 10px 14px;
    font-family: 'SF Mono', ui-monospace, monospace;
    font-size: 11px;
    line-height: 1.7;
    color: #666;
    z-index: 20;
    pointer-events: none;
    min-width: 180px;
  }
  #stylus-hud .label {
    color: #555;
    display: inline-block;
    width: 72px;
  }
  #stylus-hud .val {
    color: #aaa;
    font-variant-numeric: tabular-nums;
  }
  #stylus-hud .bar-track {
    display: inline-block;
    width: 50px;
    height: 4px;
    background: #222;
    border-radius: 2px;
    vertical-align: middle;
    margin-left: 4px;
    overflow: hidden;
  }
  #stylus-hud .bar-fill {
    height: 100%;
    background: #888;
    border-radius: 2px;
    transition: width 0.05s;
  }
</style>
</head>
<body>

<canvas id="main"></canvas>

<button id="toggle-btn" aria-label="Settings">&#9881;</button>

<!-- Stylus info HUD -->
<div id="stylus-hud">
  <div><span class="label">type</span><span class="val" id="s-type">--</span></div>
  <div><span class="label">pressure</span><span class="val" id="s-pressure">--</span><span class="bar-track"><span class="bar-fill" id="s-pressure-bar" style="width:0%"></span></span></div>
  <div><span class="label">tiltX</span><span class="val" id="s-tiltx">--</span></div>
  <div><span class="label">tiltY</span><span class="val" id="s-tilty">--</span></div>
  <div><span class="label">altitude</span><span class="val" id="s-altitude">--</span></div>
  <div><span class="label">azimuth</span><span class="val" id="s-azimuth">--</span></div>
  <div><span class="label">twist</span><span class="val" id="s-twist">--</span></div>
  <div><span class="label">position</span><span class="val" id="s-pos">--</span></div>
</div>

<div id="controls">
  <div class="cg">
    <label>Speed</label>
    <input type="range" id="r-speed" min="0" max="6" step="0.1" value="1.5">
    <span class="v" id="v-speed">1.5</span>
  </div>
  <div class="cg">
    <label>Size</label>
    <input type="range" id="r-size" min="1" max="40" step="1" value="14">
    <span class="v" id="v-size">14</span>
  </div>
  <button id="btn-clear">Clear</button>
  <button id="btn-pause">Pause</button>
</div>

<script>
(() => {
  // ── DOM ──
  const canvas = document.getElementById('main');
  const ctx    = canvas.getContext('2d');
  const score  = document.createElement('canvas');
  const sctx   = score.getContext('2d');

  // ── Stylus HUD elements ──
  const sType        = document.getElementById('s-type');
  const sPressure    = document.getElementById('s-pressure');
  const sPressureBar = document.getElementById('s-pressure-bar');
  const sTiltX       = document.getElementById('s-tiltx');
  const sTiltY       = document.getElementById('s-tilty');
  const sAltitude    = document.getElementById('s-altitude');
  const sAzimuth     = document.getElementById('s-azimuth');
  const sTwist       = document.getElementById('s-twist');
  const sPos         = document.getElementById('s-pos');

  // ── Settings ──
  let scrollSpeed = 1.5;
  let maxRadius   = 14;
  let paused      = false;

  // ── Derived ──
  let W, H, dpr;
  let lanes = [];

  // ── Drawing state ──
  let drawing = false;
  let prevX = 0, prevY = 0, prevP = 0;

  // ────────────────────────────────────────────
  //  Resize
  // ────────────────────────────────────────────
  function resize() {
    dpr = window.devicePixelRatio || 1;
    W = window.innerWidth;
    H = window.innerHeight;

    const tmp = document.createElement('canvas');
    tmp.width = score.width;
    tmp.height = score.height;
    if (score.width > 0 && score.height > 0) {
      tmp.getContext('2d').drawImage(score, 0, 0);
    }

    canvas.width  = W * dpr;
    canvas.height = H * dpr;
    score.width   = W * dpr;
    score.height  = H * dpr;

    if (tmp.width > 0 && tmp.height > 0) {
      sctx.drawImage(tmp, 0, 0, tmp.width, tmp.height, 0, 0, score.width, score.height);
    }

    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    sctx.setTransform(dpr, 0, 0, dpr, 0, 0);

    // 3 horizontal lines, evenly spaced
    lanes = [H * 0.25, H * 0.5, H * 0.75];
  }

  // ────────────────────────────────────────────
  //  Brush
  // ────────────────────────────────────────────
  function stamp(x, y, pressure) {
    const r = Math.max(0.8, pressure * maxRadius);
    sctx.beginPath();
    sctx.arc(x, y, r, 0, Math.PI * 2);
    sctx.fill();
  }

  function strokeSegment(x0, y0, p0, x1, y1, p1) {
    const dx = x1 - x0, dy = y1 - y0;
    const dist = Math.hypot(dx, dy);

    if (dist < 0.5) { stamp(x1, y1, p1); return; }

    const avgR = Math.max(1, ((p0 + p1) / 2) * maxRadius);
    const spacing = Math.max(0.8, avgR * 0.25);
    const n = Math.max(1, Math.ceil(dist / spacing));

    for (let i = 0; i <= n; i++) {
      const t = i / n;
      stamp(
        x0 + dx * t,
        y0 + dy * t,
        p0 + (p1 - p0) * t
      );
    }
  }

  // ────────────────────────────────────────────
  //  Stylus HUD update
  // ────────────────────────────────────────────
  function updateHUD(e) {
    sType.textContent = e.pointerType || '--';
    const p = e.pressure ?? 0;
    sPressure.textContent = p.toFixed(3);
    sPressureBar.style.width = (p * 100) + '%';
    sTiltX.textContent = (e.tiltX ?? 0) + '\u00B0';
    sTiltY.textContent = (e.tiltY ?? 0) + '\u00B0';
    sAltitude.textContent = e.altitudeAngle != null ? (e.altitudeAngle * 180 / Math.PI).toFixed(1) + '\u00B0' : '--';
    sAzimuth.textContent = e.azimuthAngle != null ? (e.azimuthAngle * 180 / Math.PI).toFixed(1) + '\u00B0' : '--';
    sTwist.textContent = (e.twist ?? 0) + '\u00B0';
    sPos.textContent = Math.round(e.clientX) + ', ' + Math.round(e.clientY);
  }

  // ────────────────────────────────────────────
  //  Pointer events  (pen + mouse; ignore finger)
  // ────────────────────────────────────────────
  function onDown(e) {
    if (e.pointerType === 'touch') return;
    e.preventDefault();
    canvas.setPointerCapture(e.pointerId);

    drawing = true;
    prevX = e.clientX;
    prevY = e.clientY;
    prevP = e.pressure || 0.5;

    sctx.fillStyle = '#fff';
    stamp(prevX, prevY, prevP);
    updateHUD(e);
  }

  function onMove(e) {
    updateHUD(e);
    if (!drawing) return;
    e.preventDefault();

    const events = e.getCoalescedEvents ? e.getCoalescedEvents() : [e];
    sctx.fillStyle = '#fff';

    for (const ce of events) {
      const x = ce.clientX;
      const y = ce.clientY;
      const p = ce.pressure || 0.5;
      strokeSegment(prevX, prevY, prevP, x, y, p);
      prevX = x;
      prevY = y;
      prevP = p;
    }
  }

  function onUp(e) {
    drawing = false;
    if (e) updateHUD(e);
  }

  canvas.addEventListener('pointerdown', onDown);
  canvas.addEventListener('pointermove', onMove);
  canvas.addEventListener('pointerup', onUp);
  canvas.addEventListener('pointercancel', onUp);

  // ────────────────────────────────────────────
  //  Animation loop
  // ────────────────────────────────────────────
  function frame() {
    // 1) Scroll score canvas left
    if (!paused && scrollSpeed > 0) {
      const shift = scrollSpeed * dpr;
      sctx.save();
      sctx.setTransform(1, 0, 0, 1, 0, 0);
      sctx.globalCompositeOperation = 'copy';
      sctx.drawImage(score, -shift, 0);
      sctx.globalCompositeOperation = 'source-over';
      sctx.restore();

      if (drawing) prevX -= scrollSpeed;
    }

    // 2) Render to display canvas
    ctx.save();
    ctx.setTransform(1, 0, 0, 1, 0, 0);
    ctx.fillStyle = '#000';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(score, 0, 0);
    ctx.restore();

    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

    // 3) Staff lines (2 dividers -> 3 tracks)
    ctx.strokeStyle = 'rgba(255,255,255,0.22)';
    ctx.lineWidth = 1;
    for (const y of lanes) {
      ctx.beginPath();
      ctx.moveTo(0, y);
      ctx.lineTo(W, y);
      ctx.stroke();
    }

    // 4) Drawing-zone indicator
    const zx = W * 0.75;
    ctx.save();
    ctx.strokeStyle = 'rgba(255,255,255,0.06)';
    ctx.lineWidth = 1;
    ctx.setLineDash([5, 10]);
    ctx.beginPath();
    ctx.moveTo(zx, 0);
    ctx.lineTo(zx, H);
    ctx.stroke();
    ctx.restore();

    requestAnimationFrame(frame);
  }

  // ────────────────────────────────────────────
  //  Controls
  // ────────────────────────────────────────────
  const toggleBtn = document.getElementById('toggle-btn');
  const controls  = document.getElementById('controls');

  toggleBtn.addEventListener('click', () => controls.classList.toggle('visible'));

  const rSpeed = document.getElementById('r-speed');
  const vSpeed = document.getElementById('v-speed');
  rSpeed.addEventListener('input', () => {
    scrollSpeed = parseFloat(rSpeed.value);
    vSpeed.textContent = scrollSpeed.toFixed(1);
  });

  const rSize = document.getElementById('r-size');
  const vSize = document.getElementById('v-size');
  rSize.addEventListener('input', () => {
    maxRadius = parseInt(rSize.value, 10);
    vSize.textContent = maxRadius;
  });

  document.getElementById('btn-clear').addEventListener('click', () => {
    sctx.save();
    sctx.setTransform(1, 0, 0, 1, 0, 0);
    sctx.clearRect(0, 0, score.width, score.height);
    sctx.restore();
  });

  const btnPause = document.getElementById('btn-pause');
  btnPause.addEventListener('click', () => {
    paused = !paused;
    btnPause.textContent = paused ? 'Play' : 'Pause';
  });

  // ── Init ──
  window.addEventListener('resize', resize);
  resize();
  requestAnimationFrame(frame);
})();
</script>
</body>
</html>
